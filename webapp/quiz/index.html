<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>–ö–≤–∏–∑-–∑–∞—è–≤–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --border:#e9e9e9;
      --txt:#111; --muted:#666; --err:#b00020;
      --btn:#111; --btn-txt:#fff;
      --input-border:#cfcfcf; --input-focus:#888;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f0f10; --card:#161618; --border:#242428;
        --txt:#eaeaea; --muted:#a6a6a6; --err:#ff6b7a;
        --btn:#eaeaea; --btn-txt:#111;
        --input-border:#35353a; --input-focus:#6b6b6b;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{padding:20px}
    .card{
      max-width:720px;margin:0 auto;background:var(--card);
      border:1px solid var(--border);border-radius:16px;
      box-shadow:0 1px 8px rgba(0,0,0,.06);padding:20px
    }
    h3{margin:0 0 10px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;border:1px solid var(--input-border);
      border-radius:12px;font:inherit;background:transparent;color:var(--txt);
      outline:none;transition:border-color .15s ease
    }
    input:focus,textarea:focus{border-color:var(--input-focus)}
    small.err{display:block;color:var(--err);margin-top:6px;min-height:1em}
    .notice{margin-top:8px;color:var(--muted)}
    .warn{
      display:none;padding:12px;border-radius:12px;margin:10px 0;
      background:#fff3cd;border:1px solid #ffeeba;color:#856404
    }
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button{
      padding:12px 16px;border:0;border-radius:12px;cursor:pointer;
      background:var(--btn);color:var(--btn-txt)
    }
    #send[disabled]{opacity:.5;cursor:not-allowed}
    .pill{
      border:1px dashed var(--border);color:var(--muted);
      padding:8px 10px;border-radius:999px;font-size:.9rem
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>–ö–≤–∏–∑-–∑–∞—è–≤–∫–∞</h3>

      <div id="warn" class="warn">
        –ü–æ—Ö–æ–∂–µ, –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–æ—Ä–º—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ß—Ç–æ–±—ã –±–æ—Ç –æ—Ç–≤–µ—Ç–∏–ª –≤ Telegram, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ—ë –∏–∑ –¥–∏–∞–ª–æ–≥–∞ —Å –±–æ—Ç–æ–º –ø–æ –∫–Ω–æ–ø–∫–µ ¬´üß™ –ö–≤–∏–∑ (–≤ Telegram)¬ª.
      </div>

      <div class="pill" id="who" style="display:none"></div>

      <label for="company">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
      <textarea id="company" rows="3" placeholder="–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å?" minlength="3" required></textarea>
      <small id="e_company" class="err"></small>

      <label for="task">–ó–∞–¥–∞—á–∞</label>
      <textarea id="task" rows="3" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ—Ç—É?" minlength="5" required></textarea>
      <small id="e_task" class="err"></small>

      <label for="contact">–ö–æ–Ω—Ç–∞–∫—Ç</label>
      <input id="contact" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω/email" required>
      <small id="e_contact" class="err"></small>

      <div class="actions">
        <button id="send" type="button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="notice">–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. –ù–∞–∂–º–∏—Ç–µ Ctrl/‚åò+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.</div>
    </div>
  </div>

  <script>
  (function(){
    const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
    const $  = (id)=>document.getElementById(id);
    const btn = $("send");

    // --- Theme bridge (–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ç–µ–º—É –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º–∞) ---
    function applyTheme(tp){
      if (!tp) return;
      const set = (name, hex)=>{ if(hex){ document.documentElement.style.setProperty(name, hex.startsWith('#')?hex:('#'+hex)); } };
      set('--bg', tp.bg_color);
      set('--card', tp.secondary_bg_color || tp.bg_color);
      set('--txt', tp.text_color);
      set('--muted', tp.hint_color);
      set('--btn', tp.button_color);
      set('--btn-txt', tp.button_text_color);
      set('--input-border', tp.secondary_bg_color || tp.hint_color);
      if (tp.section_bg_color) set('--border', tp.section_bg_color);
    }
    if (tg){
      try{ tg.expand(); tg.ready(); applyTheme(tg.themeParams||{}); tg.onEvent('themeChanged', ()=>applyTheme(tg.themeParams||{})); }catch(e){}
    }

    // –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ WebView –¢–µ–ª–µ–≥—Ä–∞–º–∞
    if (!tg) { $("warn").style.display = "block"; }

    // –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ –±–µ–π–¥–∂
    try{
      const u = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
      if (u){
        const badge = [];
        if (u.first_name) badge.push(u.first_name);
        if (u.last_name)  badge.push(u.last_name);
        if (u.username)   badge.push(`(@${u.username})`);
        if (badge.length){ const who = $("who"); who.textContent = badge.join(' '); who.style.display='inline-block'; }
        if (u.username && !($("contact").value||'').trim()){ $("contact").value = `@${u.username}`; }
      }
    }catch(e){}

    // --- –í–∞–ª–∏–¥–∞—Ü–∏—è ---
    function isValidContact(v){
      v = (v||"").trim();
      if (/^@[a-zA-Z0-9_]{5,}$/.test(v)) return true;
      if (/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) return true;
      const d = v.replace(/\D+/g,""); return d.length>=7 && d.length<=15;
    }
    const errs = { company:$("e_company"), task:$("e_task"), contact:$("e_contact") };
    const fields = ["company","task","contact"];

    function showErr(id,msg){ errs[id].textContent = msg||""; }
    function clearErr(id){ errs[id].textContent = ""; }

    function validate(show){
      let ok = true;
      const company = $("company").value.trim();
      const task    = $("task").value.trim();
      const contact = $("contact").value.trim();

      if (!company || company.length<3){ ok=false; if(show) showErr("company","–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞"); } else if(show) clearErr("company");
      if (!task || task.length<5){ ok=false; if(show) showErr("task","–ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤"); } else if(show) clearErr("task");
      if (!contact || !isValidContact(contact)){ ok=false; if(show) showErr("contact","–£–∫–∞–∂–∏ @username, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email"); } else if(show) clearErr("contact");

      btn.disabled = !ok;

      if (tg && tg.MainButton){
        tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å");
        if (ok){ tg.MainButton.show(); tg.MainButton.enable(); } else { tg.MainButton.disable(); }
      }
      return ok;
    }

    // –∞–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø—É—Å—Ç–æ–º/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –ø–æ–ª–µ
    function focusFirstInvalid(){
      const company = $("company").value.trim();
      const task    = $("task").value.trim();
      const contact = $("contact").value.trim();
      if (company.length<3){ $("company").focus(); return; }
      if (task.length<5){ $("task").focus(); return; }
      if (!isValidContact(contact)){ $("contact").focus(); return; }
    }

    // live-–≤–∞–ª–∏–¥–∞—Ü–∏—è + –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    fields.forEach(id => $(id).addEventListener("input", ()=>validate(true)));

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Ctrl/‚åò+Enter –≤ textarea
    ["company","task"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{
        if ((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); btn.click(); }
      });
    });
    $("contact").addEventListener("keydown", (e)=>{
      if (e.key==="Enter"){ e.preventDefault(); btn.click(); }
    });

    let sending = false;
    async function send(){
      if (sending) return;
      const ok = validate(true);
      if(!ok){ focusFirstInvalid(); return; }

      sending = true;
      btn.disabled = true;

      const payload = {
        company: $("company").value.trim(),
        task: $("task").value.trim(),
        contact: $("contact").value.trim(),
        nonce: Math.random().toString(36).slice(2) + Date.now()
      };

      // 1) Telegram WebApp
      try{ if (tg && tg.sendData) tg.sendData(JSON.stringify(payload)); }catch(e){ console.log("tg.sendData failed:", e); }

      // 2) –ë—ç–∫–∞–ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try{
        const r = await fetch('/webapp/submit', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-From-WebApp':'1'},
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          const j = await r.json().catch(()=>({error:"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"}));
          throw new Error(j.error||("HTTP "+r.status));
        }
        document.querySelector('.card').innerHTML =
          '<h3>–í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, —Å–ø–∞—Å–∏–±–æ! ‚úÖ</h3><p>–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>';
      }catch(e){
        alert(e.message||e);
        sending = false;
        btn.disabled = !validate(false);
        return;
      }finally{
        if (tg && tg.close) tg.close();
      }
    }

    btn.addEventListener('click', send);
    if (tg && tg.MainButton){ tg.MainButton.onClick(send); }

    // –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–æ–≥–æ–Ω + –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
    validate(false);
    focusFirstInvalid();
  })();
  </script>
</body>
</html>
